// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.9/esri/copyright.txt for details.
//>>built
require({cache:{"esri/views/3d/layers/support/overlayImageUtils":function(){define("require exports ../../../../geometry/support/aaBoundingRect ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/Util".split(" "),function(w,v,D,k,E,t){function B(d,e){return E.createSquareGeometry([[d[0],d[1],e],[d[2],d[1],e],[d[2],d[3],e],[d[0],d[3],e]])}Object.defineProperty(v,"__esModule",{value:!0});var g=new Float32Array([0,0,1]);v.createGeometryForExtent=B;v.createOuterImageGeometry=
function(d,e,q){if(!D.intersects(d,e))return B(e,q);var m=[d[1]-e[1],Math.min(d[3],e[3])-Math.max(d[1],e[1]),e[3]-d[3],123456],x=[d[0]-e[0],Math.min(d[2],e[2])-Math.max(d[0],e[0]),e[2]-d[2],123456],v=e[2]-e[0],w=e[3]-e[1],l=0<x[0]&&0<x[2]?3:2;d=0<m[0]&&0<m[2]?3:2;var u=(d+1)*(l+1),n=new Float32Array(3*u),u=new Float32Array(2*u);d=new Uint32Array(6*(d*l-1));for(var y=0,z=0,C=0,r=0,p=0,b=0;4>b;b++){var a=m[b];if(!(0>=a)){for(var c=0,f=0;4>f;f++){var h=x[f];0>=h||(n[z++]=e[0]+c,n[z++]=e[1]+y,n[z++]=
q,u[C++]=c/v,u[C++]=y/w,3>f&&3>b&&(1!==f||1!==b)&&(d[p++]=r,d[p++]=r+1,d[p++]=r+l+1,d[p++]=r+1,d[p++]=r+l+2,d[p++]=r+l+1),r++,c+=h)}y+=a}}e={};e[t.VertexAttrConstants.POSITION]={size:3,data:n};e[t.VertexAttrConstants.NORMAL]={size:3,data:g};e[t.VertexAttrConstants.UV0]={size:2,data:u};q={};m=new Uint32Array(d.length);for(n=0;n<m.length;n++)m[n]=0;q[t.VertexAttrConstants.POSITION]=d;q[t.VertexAttrConstants.NORMAL]=m;q[t.VertexAttrConstants.UV0]=d;return new k(e,q)}})}}});
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../core/Handles ../../../core/Logger ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../../../geometry/Extent ../../../geometry/support/aaBoundingRect ./LayerView3D ./support/overlayImageUtils ./support/projectExtentUtils ../lib/gl-matrix ../support/debugFlags ../webgl-engine/Stage ../webgl-engine/lib/RenderGeometry ../webgl-engine/lib/Texture ../webgl-engine/materials/DefaultMaterial ../../layers/RefreshableLayerView".split(" "),function(w,
v,D,k,E,t,B,g,d,e,q,m,x,F,G,l,u,n,y,z){var C=t.getLogger("esri.views.3d.layers.DynamicLayerView3D");w=function(p){function b(){var a=null!==p&&p.apply(this,arguments)||this;a.supportsDraping=!0;a.hasDraped=!0;a.fullExtentInLocalViewSpatialReference=null;a.overlayUpdating=!1;a.maximumDataResolution=null;a._handles=new E;a._images=[];a._extents=[];return a}D(b,p);Object.defineProperty(b.prototype,"drawingOrder",{get:function(){return this._get("drawingOrder")},set:function(a){if(a!==this._get("drawingOrder")){this._set("drawingOrder",
a);var c=new Set;this._images.forEach(function(f){f&&f.material&&(f.material.renderPriority=a,c.add(f.material.id))});0<c.size&&(this.view._stage.getDrapedTextureRenderer().updateRenderOrder(c),this.emit("draped-data-change"))}},enumerable:!0,configurable:!0});b.prototype.initialize=function(){var a=this;this.drawingOrder=this.view.getDrawingOrder(this.layer.uid);this.addResolvingPromise(x.toViewIfLocal(this).then(function(c){return a._set("fullExtentInLocalViewSpatialReference",c)}));this._handles.add(this.watch("suspended",
function(){return a._suspendedChangeHandler()}));var c=this.notifyChange.bind(this,"suspended");this._handles.add(this.view.resourceController.registerIdleFrameWorker({idleBegin:function(){a._isScaleRangeActive()&&c()}}));this._isScaleRangeLayer()&&this._handles.add([this.layer.watch("minScale",c),this.layer.watch("maxScale",c)],"layer");this._handles.add([this.watch("fullOpacity",this._opacityChangeHandler.bind(this)),this.layer.on("redraw",this._layerRedrawHandler.bind(this))],"layer")};b.prototype.destroy=
function(){this.clear();this._handles.destroy()};b.prototype.setDrapingExtent=function(a,c,f,b,A){b=this._extentAndSizeAtResolution(c,f,b);c=b.size;b=b.extent;if("imageMaxWidth"in this.layer||"imageMaxHeight"in this.layer){var d=this.layer.imageMaxWidth,h=this.layer.imageMaxHeight;c.width>d&&(c.height=Math.floor(c.height*d/c.width),c.width=d);c.height>h&&(c.width=Math.floor(c.width*h/c.height),c.height=h)}d=this._extents[a];d&&e.equals(d.extent,b)&&!this._imageSizeDiffers(b,f,d.imageSize,c)||(this._extents[a]=
{extent:e.create(b),spatialReference:f,imageSize:c,renderLocalOrigin:A},this.suspended||this._fetch(a))};b.prototype.getGraphicFromGraphicUid=function(a){return B.reject()};b.prototype.clear=function(){for(var a=0;a<this._images.length;a++)this._clearImage(a)};b.prototype.doRefresh=function(){this.suspended||this.refetch()};b.prototype.canResume=function(){if(!this.inherited(arguments))return!1;if(this._isScaleRangeLayer()){var a=this.layer,c=a.minScale,a=a.maxScale;if(0<c||0<a){var f=this.view.scale;
if(f<a||0<c&&f>c)return!1}}return!0};b.prototype.isUpdating=function(){if(this.overlayUpdating)return!0;for(var a=0,c=this._images;a<c.length;a++)if(c[a].loadingPromise)return!0;return!1};b.prototype.processResult=function(a,c){if(c instanceof HTMLImageElement||c instanceof HTMLCanvasElement)a.image=c};b.prototype.updateImage=function(a){return!1};b.prototype.refetch=function(){for(var a=0;a<this._extents.length;a++)this._extents[a]&&this._fetch(a)};b.prototype.beforeFetch=function(){};b.prototype.findExtentInfoAt=
function(a){for(var c=0,f=this._extents;c<f.length;c++){var b=f[c],e=b.extent;if((new d(e[0],e[1],e[2],e[3],b.spatialReference)).contains(a))return b}return null};b.prototype._imageSizeDiffers=function(a,c,f,b){if(!this.maximumDataResolution||G.TESTS_DISABLE_UPDATE_THROTTLE_THRESHOLDS)return!0;c=e.width(a)/this.maximumDataResolution.x;a=e.height(a)/this.maximumDataResolution.y;a=Math.abs(a/f.height-a/b.height);return 1.5<Math.abs(c/f.width-c/b.width)||1.5<a?!0:!1};b.prototype._fetch=function(a){var c=
this;if(!this.suspended){this.beforeFetch();var b=this._extents[a],h=b.extent,A=new d(h[0],h[1],h[2],h[3],b.spatialReference);this._images[a]||(this._images[a]={texture:null,material:null,rendergeometry:null,loadingPromise:null,image:null,pixelData:null,renderExtent:e.create(h)});var g=this._images[a];g.loadingPromise&&g.loadingPromise.cancel();0===A.width||0===A.height?this._clearImage(a):(g.loadingPromise=this.layer.fetchImage(A,b.imageSize.width,b.imageSize.height,{requestAsImageElement:!0}),g.loadingPromise.then(function(b){e.set(g.renderExtent,
h);c.processResult(g,b);c._createStageObjects(a,g.image);0===a&&c._images[1]&&c._images[1].rendergeometry&&c._createStageObjects(1,null);c.notifyChange("updating");c.emit("draped-data-change")}).catch(function(a){a&&"CancelError"!==a.name&&"cancel"!==a.dojoType&&C.error(a);c.notifyChange("updating")}).always(function(){g.loadingPromise=null}),this.notifyChange("updating"))}};b.prototype._clearImage=function(a){a=this._images[a];var c=this.view._stage;a&&(a.rendergeometry&&(c.getDrapedTextureRenderer().removeRenderGeometries([a.rendergeometry]),
a.rendergeometry=null),a.texture&&(c.remove(l.ModelContentType.TEXTURE,a.texture.id),a.texture=null),a.material&&(c.remove(l.ModelContentType.MATERIAL,a.material.id),a.material=null),a.loadingPromise&&(a.loadingPromise.cancel(),a.loadingPromise=null),a.image=null,a.pixelData=null)};b.prototype._createStageObjects=function(a,c){var b=this.view._stage,e=b.getDrapedTextureRenderer(),d=this._images[a];c&&(d.texture&&b.remove(l.ModelContentType.TEXTURE,d.texture.id),d.texture=new n(c,"dynamicLayer",{width:c.width,
height:c.height,wrapClamp:!0}),b.add(l.ModelContentType.TEXTURE,d.texture));d.material?c&&d.material.setParameterValues({textureId:d.texture.id}):(d.material=new y({ambient:[1,1,1],diffuse:[0,0,0],transparent:!0,opacity:this.fullOpacity,textureId:d.texture.id,receiveSSAO:!1},"dynamicLayer"),d.material.renderPriority=this.drawingOrder,b.add(l.ModelContentType.MATERIAL,d.material));c=this._extents[a].renderLocalOrigin;if(0===a)a=m.createGeometryForExtent(d.renderExtent,-1);else if(1===a){a=this._images[0].renderExtent;
if(!a)return;a=m.createOuterImageGeometry(a,d.renderExtent,-1)}else{console.error("DynamicLayerView3D._createStageObjects: Invalid extent idx");return}b=new u(a);b.material=d.material;b.origin=c;b.transformation=F.mat4d.identity();b.name="dynamicLayer";b.uniqueName="dynamicLayer#"+a.id;e.addRenderGeometries([b]);d.rendergeometry&&e.removeRenderGeometries([d.rendergeometry]);d.rendergeometry=b};b.prototype._isScaleRangeLayer=function(){return"minScale"in this.layer&&"maxScale"in this.layer};b.prototype._isScaleRangeActive=
function(){return this._isScaleRangeLayer()?0<this.layer.minScale||0<this.layer.maxScale:!1};b.prototype._extentAndSizeAtResolution=function(a,c,b){var d=e.width(a)/e.height(a),f={width:b,height:b};1.0001<d?f.height=b/d:.9999>d&&(f.width=b*d);c=this._clippedExtent(a,c,r);f.width=Math.round(f.width/(e.width(a)/e.width(c)));f.height=Math.round(f.height/(e.height(a)/e.height(c)));return{size:f,extent:c}};b.prototype._clippedExtent=function(a,c,b){if("local"!==this.view.viewingMode)return e.set(b,a);
c=this.view.basemapTerrain;var d=c.extent;return c.ready&&d?e.intersection(a,d,b):e.set(b,a)};b.prototype._opacityChangeHandler=function(a){for(var b=0,d=this._images;b<d.length;b++){var e=d[b];e&&e.material&&e.material.setParameterValues({opacity:a})}this.emit("draped-data-change")};b.prototype._layerRedrawHandler=function(){for(var a=!1,b=0;b<this._images.length;b++){var d=this._images[b];this.updateImage(d)&&(a=!0,this._createStageObjects(b,d.image))}a&&this.emit("draped-data-change")};b.prototype._suspendedChangeHandler=
function(){if(this.suspended)this.clear(),this.emit("draped-data-change");else for(var a=0;a<this._extents.length;a++)this._fetch(a)};k([g.property()],b.prototype,"layer",void 0);k([g.property({dependsOn:["view.scale","layer.minScale","layer.maxScale"]})],b.prototype,"suspended",void 0);k([g.property({type:Boolean})],b.prototype,"supportsDraping",void 0);k([g.property({type:Boolean})],b.prototype,"hasDraped",void 0);k([g.property({value:0,type:Number})],b.prototype,"drawingOrder",null);k([g.property({readOnly:!0})],
b.prototype,"fullExtentInLocalViewSpatialReference",void 0);k([g.property()],b.prototype,"overlayUpdating",void 0);k([g.property({dependsOn:["overlayUpdating"]})],b.prototype,"updating",void 0);return b=k([g.subclass("esri.views.3d.layers.DynamicLayerView3D")],b)}(g.declared(q,z));var r=e.create();return w});